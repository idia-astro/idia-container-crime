Bootstrap: debootstrap
MirrorURL: http://archive.ubuntu.com/ubuntu/
OSVersion: jammy

%help

        An Ubuntu 22.04 container with CRIME. The CRIME software is located at /opt/CRIME.

%labels
        APPLICATION_NAME Ubuntu LTS + CRIME
        OS_VERSION 22.04
        APPLICATION_URL https://github.com/damonge/CRIME.git

        SYSTEM_NAME iLifu
        SYSTEM_SINGULARITY_VERSION 3.9.1
        SYSTEM_URL http://www.ilifu.ac.za

        AUTHOR_NAME IDIA
        AUTHOR_EMAIL support@ilifu.ac.za

%environment

        export PATH=$PATH:/opt/CRIME
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/libsharp/auto/lib
        export PATH=$PATH:/opt/fg_rm
%post

        # Create Installation Directories and export paths. This is needed as part of post.
        # %environment scriptlet does not define these paths during %post, only after.
        mkdir -p /opt
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y software-properties-common
        add-apt-repository -y multiverse 
        apt-add-repository -y universe
        apt-get update -y
        apt-get install -y wget vim apt-utils git build-essential bzip2 curl pkg-config make cmake

        # Install CRIME dependencies
        apt-get install -y libopenmpi-dev libgsl-dev libfftw3-dev libfftw3-mpi-dev libchealpix-dev libcfitsio-dev dh-autoreconf
        cd /opt
        git clone https://github.com/Libsharp/libsharp.git
        cd libsharp/
        autoreconf -i
        CFLAGS="-DMULTIARCH -std=c99 -O3 -ffast-math" ./configure
        make

        # Install CRIME (https://github.com/damonge/CRIME.git)
        #wget -O- http://intensitymapping.physics.ox.ac.uk/Codes/CRIME/crime-1.3.tar.gz | tar zxv -C /opt
        cd /opt
        git clone https://github.com/damonge/CRIME.git
        cd /opt/CRIME
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/libsharp/auto/lib
        sed -i -e "s|GSL_INC = -I/home/dmonge/include|GSL_INC = -I/usr/include/gsl|g" /opt/CRIME/Makefile
        sed -i -e 's|GSL_LIB = -L/home/dmonge/lib|GSL_LIB = -L/usr/lib/x86_64-linux-gnu|g' /opt/CRIME/Makefile
        sed -i -e "s|FFTW_INC =|FFTW_INC = -I/usr/include|g" /opt/CRIME/Makefile
        sed -i -e "s|FFTW_LIB =|FFTW_LIB = -L/usr/lib/x86_64-linux-gnu|g" /opt/CRIME/Makefile
        sed -i -e "s|LSHT_INC = -I/home/dmonge/Software/libsharp/auto/include|LSHT_INC = -I/opt/libsharp/auto/include|g" /opt/CRIME/Makefile
        sed -i -e "s|LSHT_LIB = -L/home/dmonge/Software/libsharp/auto/lib|LSHT_LIB = -L/opt/libsharp/auto/lib|g" /opt/CRIME/Makefile
        make

        # Install fg_rm
        cd /opt
        apt-get install -y libitpp-dev
        git clone https://github.com/damonge/fg_rm.git
        cd fg_rm
        sed -i -e "s|GSL_INC = -I/home/damonge/include|GSL_INC = -I/usr/include/gsl|g" /opt/fg_rm/Makefile
        sed -i -e 's|GSL_LIB = -L/home/damonge/lib|GSL_LIB = -L/usr/lib/x86_64-linux-gnu|g' /opt/fg_rm/Makefile
        sed -i -e "s|FFTW_INC =|FFTW_INC = -I/usr/include|g" /opt/fg_rm/Makefile
        sed -i -e "s|FFTW_LIB =|FFTW_LIB = -L/usr/lib/x86_64-linux-gnu|g" /opt/fg_rm/Makefile
        sed -i -e "s|LSHT_INC =|LSHT_INC = -I/opt/libsharp/auto/include|g" /opt/fg_rm/Makefile
        sed -i -e "s|LSHT_LIB =|LSHT_LIB = -L/opt/libsharp/auto/lib|g" /opt/fg_rm/Makefile
        make

        # Fix command prompt in Singularity 3.5.2
        printf 'export PS1="\u@$SINGULARITY_NAME:\w$ "' > /.singularity.d/env/999-psvars.sh

        # Cleanup the container
        apt-get clean
        apt-get autoclean